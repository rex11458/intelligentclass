webpackJsonp([6],{BhYo:function(e,i,t){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n={name:"",components:{RFilePreview:t("pB1M").a},props:{},data:function(){return{id:this.$route.params.id,fileExt:this.$route.params.fileExt,name:this.$route.params.name,dataList:[],previewUrl:"",loading:!1,diaologShow:!1}}},a={render:function(){var e=this.$createElement,i=this._self._c||e;return i("div",{attrs:{id:"CoursewareView"}},[i("head-top",{attrs:{title:"文件预览"}}),this._v(" "),i("r-file-preview",{attrs:{fileExt:this.fileExt,fileName:this.name,fileId:this.id}})],1)},staticRenderFns:[]};var o=t("VU/8")(n,a,!1,function(e){t("Gw0r")},"data-v-7a7b8a16",null);i.default=o.exports},CS4q:function(e,i){},CqtF:function(e,i){},Gw0r:function(e,i){},WPkN:function(e,i){},pB1M:function(e,i,t){"use strict";var n=t("bOdI"),a=t.n(n),o=(t("WJbf"),t("OhwO")),l={name:"imageView",props:{fileId:{type:String,required:!0},fileExt:{type:String,required:!0},index:{type:Number,default:1},fileTotal:{type:Number,default:0},autoLoad:{type:Boolean,default:!1}},data:function(){return{isLoad:!1,loading:!1,loadFail:!1,file:null}},computed:{indexShow:function(){return-1===["bmp","gif","jpg","png","ico"].indexOf(this.fileExt)}},mounted:function(){this.autoLoad&&this.init()},methods:{init:function(){var e=this;this.loading||this.isLoad||(this.loading=!0,this.$mainHttp.resourse.viewFile({mid:this.fileId,suffix:this.fileExt,index:this.index}).then(function(i){for(var t=new Uint8Array(i),n="",a=0;a<t.byteLength;a++)n+=String.fromCharCode(t[a]);switch(e.fileExt){case"png":e.file="data:image/png;base64,"+window.btoa(n);break;case"gif":e.file="data:image/gif;base64,"+window.btoa(n);break;case"x-icon":e.file="data:image/x-icon;base64,"+window.btoa(n);break;default:e.file="data:image/jpeg;base64,"+window.btoa(n)}e.loading=!1,e.isLoad=!0,setTimeout(function(){e.loadFail||e.$emit("finish",e.index)})}).catch(function(){e.loading=!1,e.loadFail||e.$emit("finish",e.index),e.loadFail=!0}))},view:function(){this.loadFail||this.$emit("preview",this.file)}}},s={render:function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("div",{ref:"img",staticClass:"image-view"},[t("img",{ref:"image",staticStyle:{"object-fit":"fill"},attrs:{src:e.file,alt:"",width:"100%"},on:{click:e.view}}),e._v(" "),e.loadFail?t("div",{on:{click:function(i){return i.stopPropagation(),i.preventDefault(),e.init(i)}}},[e._v("加载失败，点击重新加载")]):e._e(),e._v(" "),e.indexShow&&(e.loadFail||e.isLoad)?t("div",{staticClass:"remark"},[e._v(e._s(e.index))]):e._e()])},staticRenderFns:[]};var r=t("VU/8")(l,s,!1,function(e){t("CqtF")},"data-v-66a6ddc6",null).exports,f=t("0zVH"),d=t("eQnu"),c=t.n(d),h={name:"VideoView",components:{tVideo:f.a},props:{fileId:{type:String,required:!0}},data:function(){return{mediaPoster:c.a,isLoad:!1,loading:!1,loadFail:!1,file:null}},computed:{mediaSrc:function(){return this.$mainHttp.resourse.file(this.fileId)}},mounted:function(){},methods:{}},u={render:function(){var e=this.$createElement,i=this._self._c||e;return i("div",{ref:"img",staticClass:"video-view"},[i("t-video",{attrs:{src:this.mediaSrc,poster:this.mediaPoster}})],1)},staticRenderFns:[]};var m=t("VU/8")(h,u,!1,function(e){t("raRI")},"data-v-3b029c08",null).exports,v={name:"r-file-view",components:a()({ImageView:r,VideoView:m},o.a.Component.name,o.a.Component),props:{fileId:{type:String,required:!0},fileName:{type:String,required:!0},fileExt:{type:String,required:!0},fileTotal:{type:Number,default:0}},data:function(){return{canOpenFileExt:["txt","bmp","gif","jpg","png","ico","mp4"],txtContent:"",loadIndex:1,finishedHeight:0,canLoad:!0,active:1,viewTotal:1,allFinished:!1,startIndex:0,viewIndex:1,viewShow:!1,viewImages:[]}},computed:{fullName:function(){return this.fileName+"."+this.fileExt}},mounted:function(){},methods:{load:function(){this.init(),window.addEventListener("scroll",this.lazyLoad);var e=document.getElementById("file-preview");e&&e.addEventListener("scroll",this.lazyLoad)},init:function(){var e=this;if("txt"===this.fileExt)this.$mainHttp.resourse.viewTxt({mid:this.fileId}).then(function(i){i.Result?e.txtContent=i.Data:e.txtContent="加载失败"}).catch(function(){e.txtContent="加载异常"});else if(-1===this.canOpenFileExt.findIndex(function(i){return i===e.fileExt})){this.active=0,this.viewImages=[];for(var i=0;i<this.fileTotal;i++)this.viewImages.push("");this.$nextTick(function(){e.lazyLoad()})}},lazyLoad:function(){var e=this;this.fileTotal<1||this.canOpenFileExt.indexOf(this.fileExt)>-1||(this.scrollPage(),this.allFinished||setTimeout(function(){e.loadImage(e.loadIndex)},200))},scrollPage:function(){var e=[];document.querySelectorAll(".lazy").forEach(function(i){e.push(i.offsetTop)});for(var i=document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementById("file-preview").scrollTop,n=0,a=0;a<e.length;a++)if(i>=e[a]&&i>0)n=a+1;else{if(!(t>=e[a]&&t>0))break;n=a+1}this.active=n>=this.fileTotal?this.fileTotal:n+1},loadImage:function(e){if(!(e>this.fileTotal)){var i=this.$refs["img"+e][0]||this.$refs["img"+e];if(i&&this.canLoad&&!i.isLoad){var t=window.innerHeight,n=document.documentElement.scrollTop||document.body.scrollTop,a=document.getElementById("file-preview").scrollTop,o=document.querySelectorAll(".lazy"),l=o.length>0?o[o.length-1].offsetTop:0,s=t+n+100>=this.finishedHeight||t+n+100>=l,r=t+a+100>=this.finishedHeight||t+a+100>=l;(s||r)&&(this.viewTotal++,this.canLoad=!1,i.init(),e>=this.fileTotal&&(this.allFinished=!0))}}},handleFinish:function(e){this.loadIndex++,this.canLoad=!0;var i=this.$refs["img"+e][0].$el.offsetHeight;this.finishedHeight+=i,this.viewImages.splice(e-1,1,this.$refs["img"+e][0].file),this.lazyLoad()},imageView:function(e){this.imagePreview=Object(o.a)({images:[e],showIndex:!1,onClose:function(){}})},toView:function(e){this.startIndex=e-1,this.onChange(e-1),this.viewShow=!0},onChange:function(e){var i=this.viewIndex;if(this.viewIndex=e+1,e===i){var t=this.viewIndex+1;if(!this.viewImages[t]&&t<=this.fileTotal){var n=this.$refs["img"+t][0]||this.$refs["img"+t];this.viewTotal++,this.canLoad=!1,n.init(),e>=this.fileTotal&&(this.allFinished=!0)}}}},watch:{fileTotal:{immediate:!0,handler:function(){this.load()}}},beforeDestroy:function(){window.removeEventListener("scroll",this.lazyLoad);var e=document.getElementById("file-preview");e&&e.removeEventListener("scroll",this.lazyLoad),this.imagePreview&&this.imagePreview.close()}},p={render:function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("div",{ref:"main",staticClass:"file-preview",attrs:{id:"file-preview"},on:{scroll:e.lazyLoad}},[t("div",{ref:"head",staticClass:"head-sticky"},["txt"!==e.fileExt&&"mp4"!==e.fileExt?t("span",[e._v(e._s(e.fileTotal)+"-"+e._s(e.active))]):e._e()]),e._v(" "),t("div",{staticClass:"file-main"},["txt"===e.fileExt?t("div",{staticClass:"file-txt"},[t("h2",[e._v(e._s(e.fullName))]),e._v(" "),t("p",[e._v("\n        "+e._s(e.txtContent)+"\n      ")])]):"mp4"===e.fileExt?t("div",[t("video-view",{attrs:{"file-id":e.fileId}}),e._v(" "),t("h2",[e._v(e._s(e.fullName))])],1):e.canOpenFileExt.indexOf(e.fileExt)>-1?t("div",{ref:"content"},[t("image-view",{attrs:{"file-id":e.fileId,"file-ext":e.fileExt,"file-total":1,index:1,"auto-load":""},on:{preview:e.imageView}}),e._v(" "),t("h2",[e._v(e._s(e.fullName))])],1):t("div",{ref:"content"},[t("h2",[e._v(e._s(e.fullName))]),e._v(" "),e._l(e.viewTotal,function(i){return t("image-view",{key:i,ref:"img"+i,refInFor:!0,staticClass:"lazy",attrs:{"file-id":e.fileId,"file-ext":e.fileExt,"file-total":e.fileTotal,index:i},on:{finish:e.handleFinish,preview:function(t){return e.toView(i)}}})}),e._v(" "),t("van-image-preview",{attrs:{"start-position":e.startIndex,images:e.viewImages,loop:!1},on:{change:e.onChange},scopedSlots:e._u([{key:"index",fn:function(){return[e._v("第"+e._s(e.viewIndex)+"页，共"+e._s(e.fileTotal)+"页")]},proxy:!0}]),model:{value:e.viewShow,callback:function(i){e.viewShow=i},expression:"viewShow"}})],2)])])},staticRenderFns:[]};var w={name:"r-file-preview",components:{RFileView:t("VU/8")(v,p,!1,function(e){t("WPkN")},"data-v-4652d2eb",null).exports},props:{fileName:{type:String,required:!0},fileExt:{type:String,default:""},fileId:{type:String,default:""}},data:function(){return{canOpenFileExt:["txt","bmp","gif","jpg","png","ico","mp4"],fileTotal:1}},mounted:function(){this.init()},methods:{init:function(){var e=this;this.canOpenFileExt.find(function(i){return i===e.fileExt})||this.$mainHttp.material.fileConvertCount({mid:this.fileId}).then(function(i){i.Result?e.fileTotal=i.Total:i.Info?(e.$toast(i.Info),e.fileTotal=0):e.fileTotal=0}).catch(function(){e.fileTotal=0})}}},g={render:function(){var e=this.$createElement,i=this._self._c||e;return i("div",{staticClass:"file-view"},[i("r-file-view",{attrs:{"file-id":this.fileId,"file-name":this.fileName,"file-ext":this.fileExt,"file-total":this.fileTotal}})],1)},staticRenderFns:[]};var x=t("VU/8")(w,g,!1,function(e){t("CS4q")},"data-v-5d2ae7fa",null);i.a=x.exports},raRI:function(e,i){}});
//# sourceMappingURL=6.5b52d4a0cd8c6fb5b1ed.js.map